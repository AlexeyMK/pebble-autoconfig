#include <pebble.h>
#include "autoconfig.h"

{%- import 'autoconfig.jinja.utils' as autoconfig_utils %}
{% set persitantDataSize = 0 %}
{% for item in preferences['items'] -%}
{% if item['type'] == 'switch' %}
bool _{{ autoconfig_utils.cname(item) }};
bool get{{ autoconfig_utils.cname(item)| capitalize }}(){return _{{ autoconfig_utils.cname(item) }};}
void set{{ autoconfig_utils.cname(item) | capitalize }}(bool value){_{{ autoconfig_utils.cname(item) }} = value;}
{% set persitantDataSize = persitantDataSize + 4 + 2 %}
{% elif item['type'] == 'choice' %}
{{ autoconfig_utils.cname(item)|capitalize }}Value _{{ autoconfig_utils.cname(item) }};
{{ autoconfig_utils.cname(item)|capitalize }}Value get{{ autoconfig_utils.cname(item)| capitalize }}(){return _{{ autoconfig_utils.cname(item) }};}
void set{{ autoconfig_utils.cname(item) | capitalize }}({{ autoconfig_utils.cname(item)|capitalize }}Value value){_{{ autoconfig_utils.cname(item) }} = value;}
{% set persitantDataSize = persitantDataSize + 4 + 4 %}
{% elif item['type'] == 'string' %}
char _{{ autoconfig_utils.cname(item) }}[{{item['max-length']}}]; 
{%- if (item['max-length']|int) > (124 - 1 - 7) %}
// Generated error for string size overflow
#error : The length of strings cannot exceed {{ 124 - 1 - 7}} bytes but your string '{{item['name']}}' is {{ item['max-length'] }} bytes long
{% endif -%}
char* get{{ autoconfig_utils.cname(item)| capitalize }}(){return _{{ autoconfig_utils.cname(item) }};}
void set{{ autoconfig_utils.cname(item) | capitalize }}(char* value){strncpy(_{{ autoconfig_utils.cname(item) }}, value, {{ item['max-length'] }});}
{% set persitantDataSize = persitantDataSize + 4 + 1 * (item['max-length']|int) %}
{% else %}
int32_t _{{ autoconfig_utils.cname(item) }};
int32_t get{{ autoconfig_utils.cname(item)| capitalize }}(){return _{{ autoconfig_utils.cname(item) }};}
void set{{ autoconfig_utils.cname(item) | capitalize}}(int32_t value){_{{ autoconfig_utils.cname(item) }} = value;}
{% set persitantDataSize = persitantDataSize + 4 + 4 %}
{% endif -%}
{%- if persitantDataSize > 4000 %}
// Generated error for persistant data size overflow
#error : The size of all persisted values cannot exceed 4KB but your parameters require {{ persitantDataSize }}B
{% endif -%}
{% endfor %}

static int32_t get_tuple_value(Tuple *tuple) {
	if (tuple->type ==  TUPLE_INT){
		if (tuple->length == 1) {
			return tuple->value->int8;
		}
		if (tuple->length == 2) {
			return tuple->value->int16;
		}
		return tuple->value->int32;
	}
	if (tuple->type ==  TUPLE_UINT){
		if (tuple->length == 1) {
			return tuple->value->uint8;
		}
		if (tuple->length == 2) {
			return tuple->value->uint16;
		}
		return tuple->value->uint32;
	}
	return 0;
}

void autoconfig_in_received_handler(DictionaryIterator *iter, void *context) {
	Tuple *tuple = NULL;
	{% for item in preferences['items']: -%}
	tuple = dict_find(iter, {{ autoconfig_utils.cname(item)|upper }}_PKEY);
	{%- if item['type'] == 'string' %}
	tuple ? set{{ autoconfig_utils.cname(item) | capitalize }}(tuple->value->cstring) : false;
	{%- else %}
	tuple ? set{{ autoconfig_utils.cname(item) | capitalize }}(tuple->value->int32) : false;
	{%- endif %}
	{% endfor %}
}

void autoconfig_init(){
	app_message_register_inbox_received(autoconfig_in_received_handler);
	app_message_open(app_message_inbox_size_maximum(), 0);

	{% for item in preferences['items']: -%}
	if (persist_exists({{ autoconfig_utils.cname(item)|upper }}_PKEY)) {
		{%- if item['type'] == 'string' %}
		persist_read_string({{ autoconfig_utils.cname(item)|upper }}_PKEY, _{{ autoconfig_utils.cname(item) }}, {{item['max-length'] + 1}});
		set{{ autoconfig_utils.cname(item) | capitalize }}(_{{ autoconfig_utils.cname(item) }});
		{%- elif item['type'] == 'switch' %}
		set{{ autoconfig_utils.cname(item) | capitalize }}(persist_read_bool({{ autoconfig_utils.cname(item)|upper }}_PKEY));
		{%- else %}
		set{{ autoconfig_utils.cname(item) | capitalize }}(persist_read_int({{ autoconfig_utils.cname(item)|upper }}_PKEY));
		{%- endif %}
	}
	{%- if item['default'] is defined %}
	else {
		{%- if item['type'] == 'string' %}
		set{{ autoconfig_utils.cname(item) | capitalize }}("{{item['default']}}");
		{%- else %}
		set{{ autoconfig_utils.cname(item) | capitalize }}({{item['default']|lower}});
		{%- endif %}
	}
	{%- endif %}

	{% endfor %}
}

void autoconfig_deinit(){
	{%- for item in preferences['items']: -%}
	{%- if item['type'] == 'string' %}
	persist_write_string({{ autoconfig_utils.cname(item)|upper }}_PKEY, _{{ autoconfig_utils.cname(item) }});
	{%- elif item['type'] == 'switch' %}
	persist_write_bool({{ autoconfig_utils.cname(item)|upper }}_PKEY, _{{ autoconfig_utils.cname(item) }});
	{%- else %}
	persist_write_int({{ autoconfig_utils.cname(item)|upper }}_PKEY, _{{ autoconfig_utils.cname(item) }});
	{%- endif %}
	{%- endfor %}
}
