Pebble.addEventListener("ready", function(e) {
    var settings;
	try {

		settings = JSON.parse(localStorage['{{shortName}}']);
	}
	catch(e) {
		settings = {
			{% for item in preferences['items']: -%}
			"{{ item['name'] }}" : "{{ item['default'] }}",
			{% endfor %}
		};
		localStorage['{{shortName}}'] = JSON.stringify(settings);
	}
	Pebble.sendAppMessage(settings);
});

Pebble.addEventListener("showConfiguration", function (e) {
    Pebble.openURL("{{ preferences['url'] }}");
});

function diff(obj1, obj2) {
    var result = {};
    for(var key in obj1)
    {
        if (!obj2.hasOwnProperty(key) || obj2[key] !== obj1[key]) {
            result[key] = obj1[key];
        }
    }
    return result;
}

Pebble.addEventListener("webviewclosed", function(e) {
    if ((typeof e.response === 'string') && (e.response.length > 0)) {
        var newSettings = decodeURIComponent(e.response);
        var newSettingsDictionary = JSON.parse(newSettings);

        var diffSettings = diff(newSettingsDictionary, JSON.parse(localStorage['{{shortName}}']));
        
        localStorage['{{shortName}}'] = newSettings;
        Pebble.sendAppMessage(diffSettings);
    }
});

/* Convenient function to automatically retry messages. */
/* from http://forums.getpebble.com/discussion/comment/83060/#Comment_83060 */
Pebble.sendAppMessageWithRetry = function(message, retryCount, successCb, failedCb) {
  var retry = 0;
  var success = function(e) {
    if (typeof successCb == "function") {
      successCb(e);
    }
  };
  var failed = function(e) {
    console.log("Failed sending message: " + JSON.stringify(message) + " - Error: " + JSON.stringify(e) + " - Retrying...");
    retry++;
    if (retry < retryCount) {
      Pebble.sendAppMessage(message, success, failed);
    }
    else {
      if (typeof failedCb == "function") {
        failedCb(e);
      }
    }
  };
  Pebble.sendAppMessage(message, success, failed);
};